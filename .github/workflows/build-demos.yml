# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Build demos

on:
   push:
      branches:
         - 'oauth2-films-demo'

jobs:
   build:
      runs-on: ubuntu-latest
      permissions:
         contents: read
         packages: write

      steps:
         -  uses: actions/checkout@v3
         -  name: Set up JDK 21
            uses: actions/setup-java@v3
            with:
               java-version: '21'
               distribution: 'temurin'
               cache: maven
         -  name: Build with Maven
            run: mvn -B package --file pom.xml

         -  name: Set up QEMU
            uses: docker/setup-qemu-action@v2

         -  name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v2

         -  name: Login to Github Container Registry
            uses: docker/login-action@v2
            with:
               registry: ghcr.io
               username: ${{ github.actor }}
               password: ${{ secrets.GITHUB_TOKEN }}

         -  name: Build and push Films API Authorisation Server.
            uses: docker/build-push-action@v4
            with:
               context: ./films-api-client-crendentials/films-api-authorisation-server
               file: ./films-api-client-crendentials/films-api-authorisation-server/Dockerfile
               push: true
               tags: ghcr.io/orbitalapi/demos-films-authorisation-server:latest

         -  name: Build and push Films API Resource Server
            uses: docker/build-push-action@v4
            with:
               context: ./films-api-client-crendentials/films-api-resource-server
               file: ./films-api-client-crendentials/films-api-resource-server
               push: true
               tags: ghcr.io/orbitalapi/demos-films-api-resource-server:latest

         - name: Build and push Films Data API
           uses: docker/build-push-action@v4
           with:
              context: ./films-api-client-crendentials/films-data-api-public
              file: ./films-api-client-crendentials/films-data-api-public
              push: true
              tags: ghcr.io/orbitalapi/demos-films-data-api-public:latest
